events {
    worker_connections  4096;  # Increased for concurrent uploads
    use epoll;  # Better performance for high concurrency
    multi_accept on;  # Accept multiple connections at once
}

http {
    # Timeout settings for large file uploads
    client_body_timeout 600s;  # Time to wait for client body (10 minutes)
    client_header_timeout 60s;  # Time to wait for client header
    send_timeout 600s;  # Time to wait for response transmission (10 minutes)
    keepalive_timeout 65s;  # Keep connections alive
    keepalive_requests 100;  # Number of requests per connection
    
    # Buffer settings for large uploads
    client_body_buffer_size 128k;
    client_max_body_size 5120M;  # Allow up to 5GB (or 5120MB)
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;
    
    server {
        server_name localhost;
        listen 7878;
        rewrite ^/(.*) /$1 break;
        
        proxy_ignore_client_abort on;
        proxy_set_header  X-Real-IP  $remote_addr;
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  Host $http_host;
        proxy_set_header Access-Control-Allow-Origin "*";

        # Apply authentication to all locations
        auth_basic "Oxigraph Administrator's Area";
        auth_basic_user_file /etc/nginx/.htpasswd;

        location / {
            proxy_pass http://oxigraph:7878;
            proxy_pass_request_headers on;
            proxy_set_header Connection "";
            proxy_http_version 1.1;
            
            # Disable buffering for large uploads (stream directly)
            proxy_buffering off;
            proxy_request_buffering off;
            
            # Timeout settings - increased for large file processing
            proxy_connect_timeout 300s;  # 5 minutes to establish connection
            proxy_send_timeout 1800s;  # 30 minutes to send data to backend
            proxy_read_timeout 1800s;  # 30 minutes to read response from backend
            
            # Keepalive settings for better connection reuse
            proxy_set_header Connection "keep-alive";
            
            # Error handling
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
            proxy_next_upstream_tries 3;
            proxy_next_upstream_timeout 10s;
            
            # Don't buffer responses - stream them
            proxy_max_temp_file_size 0;
        }
    }
}
