services:
  # PostgreSQL Database for APItokenmanager and JWT services
  postgres:
    image: postgres:15
    container_name: brainkb-postgres
    environment:
      POSTGRES_USER: ${JWT_POSTGRES_DATABASE_USER:-postgres}
      POSTGRES_PASSWORD: ${JWT_POSTGRES_DATABASE_PASSWORD:-postgres}
      POSTGRES_DB: ${JWT_POSTGRES_DATABASE_NAME:-brainkb}
    ports:
      - "${JWT_POSTGRES_DATABASE_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - brainkb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${JWT_POSTGRES_DATABASE_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Unified BrainKB Services Container
  brainkb-unified:
    build:
      context: .
      dockerfile: Dockerfile.unified
    container_name: brainkb-unified
    env_file:
      - .env
    ports:
      - "${API_TOKEN_PORT:-8000}:8000"
      - "${QUERY_SERVICE_PORT:-8010}:8010"
      - "${ML_SERVICE_PORT:-8007}:8007"
      
    volumes:
      - ./logs:/var/log/supervisor
    networks:
      - brainkb-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    # Resource limits to utilize available CPUs
    deploy:
      resources:
        limits:
          cpus: '8.0'  # Use up to 8 CPUs (out of 12 available)
          memory: 16G  # Increase memory limit
        reservations:
          cpus: '2.0'  # Reserve 2 CPUs minimum
          memory: 4G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Oxigraph SPARQL Database (separate service)
  # Note: Oxigraph is not directly exposed - access through oxigraph-nginx service
  oxigraph:
    image: ghcr.io/oxigraph/oxigraph:latest
    container_name: brainkb-oxigraph
    # No port mapping - only accessible through oxigraph-nginx
    volumes:
      - oxigraph_data:/data
      - /tmp:/tmp
    environment:
      - TMPDIR=/tmp
    ulimits:
      fsize: -1
      nofile: 65536  # Increase file descriptor limit for concurrent connections
    networks:
      - brainkb-network
    restart: unless-stopped
    # Note: For resource limits, use Docker run flags or configure in your orchestration platform
    # Recommended: 8GB memory, 4 CPUs for large concurrent uploads
    # Example: docker update --memory=8g --cpus=4.0 brainkb-oxigraph
    # Note: Healthcheck removed - oxigraph uses distroless image without shell/tools
    # The service is working (check logs: docker logs brainkb-oxigraph)
    # oxigraph-nginx will handle connection failures gracefully

  # Nginx reverse proxy with HTTP Basic Authentication for Oxigraph
  oxigraph-nginx:
    image: nginx:1.21.4
    container_name: brainkb-oxigraph-nginx
    env_file:
      - .env
    environment:
      OXIGRAPH_USER: ${OXIGRAPH_USER:-admin}
      OXIGRAPH_PASSWORD: ${OXIGRAPH_PASSWORD:-pwdoxigraph}
    volumes:
      - ./oxigraph/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "${OXIGRAPH_PORT:-7878}:7878"
    networks:
      - brainkb-network
    depends_on:
      - oxigraph
      # Note: oxigraph uses distroless image, so no healthcheck available
      # Nginx will start when oxigraph container starts and handle connection failures gracefully
    restart: unless-stopped
    # Note: For resource limits, use Docker run flags or configure in your orchestration platform
    # Recommended: 2GB memory, 2 CPUs for handling concurrent uploads
    # Example: docker update --memory=2g --cpus=2.0 brainkb-oxigraph-nginx
    ulimits:
      nofile: 65536  # Increase file descriptor limit for concurrent connections
    entrypoint: >
      sh -c 'echo -n "$$OXIGRAPH_USER:" > /etc/nginx/.htpasswd &&
      echo "$$OXIGRAPH_PASSWORD" | openssl passwd -stdin -apr1 >> /etc/nginx/.htpasswd &&
      chmod 644 /etc/nginx/.htpasswd &&
      /docker-entrypoint.sh nginx -g "daemon off;"' 

  # pgAdmin for PostgreSQL management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: brainkb-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@brainkb.org}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
      PGADMIN_SERVER_NAME: ${PGADMIN_SERVER_NAME:-BrainKB PostgreSQL}
    ports:
      - "${PGADMIN_PORT:-5051}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./pgadmin-init/servers.json:/pgadmin4/servers.json:ro
    networks:
      - brainkb-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    # Note: PostgreSQL server is automatically configured on startup
    # Note: You may see periodic "database postgres_admin does not exist" errors in PostgreSQL logs.
    # These are harmless - they come from pgAdmin's internal health checks that don't use MaintenanceDB.
    # pgAdmin correctly uses MaintenanceDB: "brainkb" from servers.json for actual operations.

volumes:
  postgres_data:
    driver: local
  oxigraph_data:
    driver: local
  pgadmin_data:
    driver: local

networks:
  brainkb-network:
    driver: bridge

